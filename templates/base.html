<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}MathLab - Kalkulator Kalkulus{% endblock %}</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      .math-card {
        transition: all 0.3s ease;
      }
      .math-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      #graph3d-container {
        width: 100%;
        height: 500px;
        position: relative;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      #graph3d {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      }
      .nav-link {
        position: relative;
      }
      .nav-link::after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        bottom: -2px;
        left: 0;
        background-color: #3b82f6;
        transition: width 0.3s ease;
      }
      .nav-link:hover::after {
        width: 100%;
      }
      .active-nav::after {
        width: 100%;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .hero-gradient {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      }
      .feature-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        font-size: 1.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .function-card {
        transition: all 0.3s ease;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      .function-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .graph-controls {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        z-index: 10;
      }
      .graph-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .graph-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
      }
      .graph-btn.active {
        background: #3b82f6;
        color: white;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen font-sans">
    <!-- Header with Navigation -->
    <header
      class="bg-gradient-to-r from-blue-600 to-indigo-800 text-white shadow-lg sticky top-0 z-50"
    >
      {% include 'header.html' %}
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      {% block content %}{% endblock %}
    </main>

    <script>
      // Tab Navigation
      function showTab(tabId) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabId).classList.add("active");

        // Update active nav link
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active-nav");
        });

        // Find the clicked link and make it active
        const links = document.querySelectorAll(".nav-link");
        for (let link of links) {
          if (link.getAttribute("onclick").includes(tabId)) {
            link.classList.add("active-nav");
            break;
          }
        }

        // If showing 3D tab, initialize the 3D graph
        if (tabId === "home") {
          init3DGraph();
        }
      }

      // Scroll to features
      function scrollToFeatures() {
        document.getElementById("features").scrollIntoView({
          behavior: "smooth",
        });
      }

      // Calculus Calculator Functions
      let chart;
      let soalLatex = "";
      const arsip = [];

      function tampilkanForm() {
        document.getElementById("output").innerHTML = "";
        if (chart) chart.destroy();
        document
          .getElementById("grafik")
          .getContext("2d")
          .clearRect(0, 0, 400, 300);

        const rumus = document.getElementById("rumus").value;
        let html = "";

        switch (rumus) {
          case "turunan_pangkat":
          case "integral_pangkat":
            html += `
                        <div>
                            <label for="a" class="block text-sm font-medium text-gray-700">a:</label>
                            <input id="a" type="number" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="n" class="block text-sm font-medium text-gray-700">n:</label>
                            <input id="n" type="number" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "turunan_trigonometri":
          case "integral_eksponen":
            html += `
                        <div>
                            <label for="a" class="block text-sm font-medium text-gray-700">a:</label>
                            <input id="a" type="number" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="b" class="block text-sm font-medium text-gray-700">b:</label>
                            <input id="b" type="number" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "limit":
            html += `
                        <div>
                            <label for="fx" class="block text-sm font-medium text-gray-700">Fungsi f(x):</label>
                            <input id="fx" value="x^2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="c" class="block text-sm font-medium text-gray-700">Nilai x → c:</label>
                            <input id="c" type="number" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "logaritma":
            html += `
                        <div>
                            <label for="b" class="block text-sm font-medium text-gray-700">Basis (b):</label>
                            <input id="b" type="number" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="x" class="block text-sm font-medium text-gray-700">Nilai x:</label>
                            <input id="x" type="number" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "fungsi_invers":
            html += `
                        <div class="md:col-span-2">
                            <label for="fx" class="block text-sm font-medium text-gray-700">Fungsi f(x):</label>
                            <input id="fx" value="2*x + 3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "garis_lurus":
            html += `
                        <div>
                            <label for="m" class="block text-sm font-medium text-gray-700">Gradien (m):</label>
                            <input id="m" type="number" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="c" class="block text-sm font-medium text-gray-700">Konstanta (c):</label>
                            <input id="c" type="number" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
          case "lingkaran":
            html += `
                        <div>
                            <label for="a" class="block text-sm font-medium text-gray-700">Pusat (a):</label>
                            <input id="a" type="number" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="b" class="block text-sm font-medium text-gray-700">Pusat (b):</label>
                            <input id="b" type="number" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="r" class="block text-sm font-medium text-gray-700">Jari-jari (r):</label>
                            <input id="r" type="number" value="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    `;
            break;
        }

        document.getElementById("formInput").innerHTML = html;
      }

      function hitung() {
        const rumus = document.getElementById("rumus").value;
        if (!rumus) {
          alert("Pilih rumus terlebih dahulu!");
          return;
        }

        const a = parseFloat(document.getElementById("a")?.value || 1);
        const n = parseFloat(document.getElementById("n")?.value || 1);
        const b = parseFloat(document.getElementById("b")?.value || 1);
        const x = parseFloat(document.getElementById("x")?.value || 1);
        const m = parseFloat(document.getElementById("m")?.value || 1);
        const c = parseFloat(document.getElementById("c")?.value || 0);
        const r = parseFloat(document.getElementById("r")?.value || 1);
        const fx = document.getElementById("fx")?.value || "x";

        let soal = "",
          hasil = "",
          error = null;
        const xData = [],
          yData = [];

        try {
          switch (rumus) {
            case "turunan_pangkat":
              soal = `f(x) = ${a}x^{${n}}`;
              hasil = `f'(x) = ${a * n}x^{${n - 1}}`;
              for (let i = -10; i <= 10; i += 0.5) {
                xData.push(i);
                yData.push(a * Math.pow(i, n));
              }
              break;

            case "integral_pangkat":
              soal = `\\int ${a}x^{${n}} \\, dx`;
              if (n === -1) {
                hasil = `${a} \\ln|x| + C`;
              } else {
                hasil = `\\frac{${a}}{${n + 1}}x^{${n + 1}} + C`;
              }
              for (let i = 0.1; i <= 10; i += 0.5) {
                xData.push(i);
                yData.push(a * Math.pow(i, n));
              }
              break;

            case "turunan_trigonometri":
              soal = `f(x) = ${a}\\sin(${b}x)`;
              hasil = `f'(x) = ${a * b}\\cos(${b}x)`;
              for (let i = -10; i <= 10; i += 0.2) {
                xData.push(i);
                yData.push(a * Math.sin(b * i));
              }
              break;

            case "integral_eksponen":
              soal = `\\int ${a}e^{${b}x} \\, dx`;
              hasil = `\\frac{${a}}{${b}}e^{${b}x} + C`;
              for (let i = -5; i <= 5; i += 0.2) {
                xData.push(i);
                yData.push(a * Math.exp(b * i));
              }
              break;

            case "limit":
              soal = `\\lim_{x \\to ${c}} ${fx}`;
              hasil = math.evaluate(fx.replace(/x/g, c));
              break;

            case "logaritma":
              soal = `\\log_{${b}}(${x})`;
              hasil = math.log(x, b);
              for (let i = 1; i <= 100; i += 5) {
                xData.push(i);
                yData.push(math.log(i, b));
              }
              break;

            case "fungsi_invers":
              soal = `f(x) = ${fx}`;
              hasil = "f⁻¹(x) = (Diperlukan penyelesaian manual)";
              for (let i = -10; i <= 10; i += 1) {
                xData.push(i);
                yData.push(math.evaluate(fx.replace(/x/g, i)));
              }
              break;

            case "garis_lurus":
              soal = `y = ${m}x + ${c}`;
              hasil = `Gradien = ${m}, Perpotongan sumbu-y = ${c}`;
              for (let i = -10; i <= 10; i += 1) {
                xData.push(i);
                yData.push(m * i + c);
              }
              break;

            case "lingkaran":
              soal = `(x - ${a})² + (y - ${b})² = ${r}²`;
              hasil = `Pusat: (${a}, ${b}), Jari-jari: ${r}`;
              // Gambar lingkaran dengan persamaan parametrik
              for (let theta = 0; theta < 2 * Math.PI; theta += 0.1) {
                xData.push(a + r * Math.cos(theta));
                yData.push(b + r * Math.sin(theta));
              }
              break;
          }
        } catch (e) {
          error = `Error: ${e.message}`;
        }

        soalLatex = soal;
        arsip.push(soal);
        tampilkanArsip();

        const outputDiv = document.getElementById("output");
        if (error) {
          outputDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">${error}</div>`;
        } else {
          outputDiv.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <strong class="block text-sm font-medium text-gray-700 mb-1">Soal:</strong>
                        <div class="text-lg">\\(${soal}\\)</div>
                        <strong class="block text-sm font-medium text-gray-700 mt-3 mb-1">Hasil:</strong>
                        <div class="text-lg">\\(${hasil}\\)</div>
                    </div>
                `;
        }

        document.getElementById("salinBtn").disabled = !soalLatex;
        MathJax.typesetPromise();

        const ctx = document.getElementById("grafik").getContext("2d");
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: rumus === "lingkaran" ? "scatter" : "line",
          data: {
            datasets: [
              {
                label: soal,
                data: xData.map((x, i) => ({ x: x, y: yData[i] })),
                borderColor: "rgb(59, 130, 246)",
                backgroundColor:
                  rumus === "lingkaran"
                    ? "rgba(59, 130, 246, 0.5)"
                    : "rgba(59, 130, 246, 0.5)",
                fill: false,
                tension: 0.3,
                showLine: rumus !== "lingkaran", // scatter pakai showLine: false
                pointRadius: rumus === "lingkaran" ? 2 : 0,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                type: "linear",
                position: "bottom",
                title: {
                  display: true,
                  text: "x",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "y",
                },
              },
            },
          },
        });
      }

      function tampilkanArsip() {
        const daftar = document.getElementById("daftarArsip");
        daftar.innerHTML = "";
        arsip
          .slice()
          .reverse()
          .forEach((soal) => {
            const item = document.createElement("li");
            item.className = "bg-gray-50 p-3 rounded-lg";
            item.innerHTML = `\\(${soal}\\)`;
            daftar.appendChild(item);
          });
        MathJax.typesetPromise();
      }

      function resetForm() {
        document.getElementById("rumus").value = "";
        document.getElementById("formInput").innerHTML = "";
        document.getElementById("output").innerHTML = "";
        document.getElementById("salinBtn").disabled = true;
        soalLatex = "";
        if (chart) chart.destroy();
        document
          .getElementById("grafik")
          .getContext("2d")
          .clearRect(0, 0, 400, 300);
      }

      function salinKeClipboard() {
        if (!soalLatex) return;
        navigator.clipboard.writeText(soalLatex).then(
          () => {
            const btn = document.getElementById("salinBtn");
            btn.innerHTML = '<i class="fas fa-check mr-2"></i> Tersalin!';
            btn.classList.remove("bg-green-600", "hover:bg-green-700");
            btn.classList.add("bg-green-500", "hover:bg-green-600");
            setTimeout(() => {
              btn.innerHTML = '<i class="fas fa-copy mr-2"></i> Salin Soal';
              btn.classList.remove("bg-green-500", "hover:bg-green-600");
              btn.classList.add("bg-green-600", "hover:bg-green-700");
            }, 2000);
          },
          () => alert("Gagal menyalin.")
        );
      }

      // Simple Calculator Functions
      let calcDisplay = document.getElementById("calcDisplay");
      let currentInput = "0";
      let previousInput = "";
      let operation = null;
      let resetScreen = false;

      function calcNumber(number) {
        if (currentInput === "0" || resetScreen) {
          currentInput = number;
          resetScreen = false;
        } else {
          currentInput += number;
        }
        updateDisplay();
      }

      function calcDecimal() {
        if (resetScreen) {
          currentInput = "0.";
          resetScreen = false;
          return;
        }
        if (currentInput.indexOf(".") === -1) {
          currentInput += ".";
        }
        updateDisplay();
      }

      function calcOperator(op) {
        if (operation !== null) calcEquals();
        previousInput = currentInput;
        operation = op;
        resetScreen = true;
      }

      function calcEquals() {
        if (operation === null || resetScreen) return;
        let computation;
        const prev = parseFloat(previousInput);
        const current = parseFloat(currentInput);

        switch (operation) {
          case "+":
            computation = prev + current;
            break;
          case "-":
            computation = prev - current;
            break;
          case "*":
            computation = prev * current;
            break;
          case "/":
            computation = prev / current;
            break;
          default:
            return;
        }

        currentInput = computation.toString();
        operation = null;
        resetScreen = true;
        updateDisplay();
      }

      function calcPercent() {
        currentInput = (parseFloat(currentInput) / 100).toString();
        updateDisplay();
      }

      function calcClear() {
        currentInput = "0";
        previousInput = "";
        operation = null;
        updateDisplay();
      }

      function calcBackspace() {
        if (
          currentInput.length === 1 ||
          (currentInput.length === 2 && currentInput.startsWith("-"))
        ) {
          currentInput = "0";
        } else {
          currentInput = currentInput.slice(0, -1);
        }
        updateDisplay();
      }

      function updateDisplay() {
        calcDisplay.value = currentInput;
      }

      // 3D Graph Functions
      let scene, camera, renderer, controls;
      let graphMesh;

      function init3DGraph() {
        const container = document.getElementById("graph3d");

        // Clear previous renderer if exists
        if (renderer) {
          container.innerHTML = "";
        }

        // Create scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8fafc);

        // Create camera
        camera = new THREE.PerspectiveCamera(
          75,
          container.clientWidth / container.clientHeight,
          0.1,
          1000
        );
        camera.position.set(4, 4, 4);

        // Create renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Add orbit controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Add axes helper
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);

        // Add grid helper
        const gridHelper = new THREE.GridHelper(10, 10, 0x888888, 0xcccccc);
        scene.add(gridHelper);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        // Initial plot
        plot3DFunction("x^2 + y^2");

        // Handle window resize
        window.addEventListener("resize", onWindowResize);

        // Start animation loop
        animate();
      }

      function plot3DFunction(expression) {
        // Remove previous graph if exists
        if (graphMesh) {
          scene.remove(graphMesh);
        }

        const size = 5;
        const divisions = 50;

        // Create geometry
        const geometry = new THREE.ParametricBufferGeometry(
          (u, v, target) => {
            const x = (u - 0.5) * size * 2;
            const y = (v - 0.5) * size * 2;
            let z;

            try {
              // Replace ^ with ** for proper evaluation
              const expr = expression.replace(/\^/g, "**");
              z = math.evaluate(expr, { x: x, y: y });

              // Limit z to prevent extreme values
              if (typeof z !== "number" || isNaN(z)) z = 0;
              if (z > size * 2) z = size * 2;
              if (z < -size * 2) z = -size * 2;
            } catch (e) {
              z = 0;
            }

            target.set(x, y, z);
          },
          divisions,
          divisions
        );

        // Create material with color based on height
        const material = new THREE.MeshPhongMaterial({
          vertexColors: true,
          side: THREE.DoubleSide,
          flatShading: true,
          transparent: true,
          opacity: 0.85,
          wireframe: false,
        });

        // Add vertex colors based on height
        const positions = geometry.attributes.position;
        const colors = [];
        const color = new THREE.Color();

        for (let i = 0; i < positions.count; i++) {
          const z = positions.getZ(i);
          // Map z value to color (blue to red gradient)
          const t = (z + size) / (2 * size);
          color.setHSL(0.6 * (1 - t), 0.8, 0.5 + t * 0.3);
          colors.push(color.r, color.g, color.b);
        }

        geometry.setAttribute(
          "color",
          new THREE.Float32BufferAttribute(colors, 3)
        );

        // Create mesh
        graphMesh = new THREE.Mesh(geometry, material);
        scene.add(graphMesh);

        // Update active button
        document.querySelectorAll(".graph-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Find and activate the corresponding button
        const buttons = document.querySelectorAll(".graph-btn");
        for (let btn of buttons) {
          if (btn.textContent === "Paraboloid" && expression === "x^2 + y^2") {
            btn.classList.add("active");
            break;
          } else if (
            btn.textContent === "Gelombang" &&
            expression === "sin(x) + cos(y)"
          ) {
            btn.classList.add("active");
            break;
          } else if (
            btn.textContent === "Bidang Miring" &&
            expression === "x*y/2"
          ) {
            btn.classList.add("active");
            break;
          } else if (
            btn.textContent === "Radial" &&
            expression === "sin(sqrt(x^2 + y^2))"
          ) {
            btn.classList.add("active");
            break;
          }
        }
      }

      function plotCustomFunction() {
        const funcInput = document.getElementById("custom-function").value;
        if (funcInput) {
          plot3DFunction(funcInput);

          // Update active button
          document.querySelectorAll(".graph-btn").forEach((btn) => {
            btn.classList.remove("active");
          });
        }
      }

      function onWindowResize() {
        const container = document.getElementById("graph3d");
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        init3DGraph();
        MathJax.typesetPromise();
      });
    </script>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
      {% include 'footer.html' %}
    </footer>
  </body>
</html>
